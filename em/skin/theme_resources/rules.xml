<rules
    xmlns="http://namespaces.plone.org/diazo"
    xmlns:css="http://namespaces.plone.org/diazo/css"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform">

    <!-- Apply theme to normal Plone pages -->
    <theme href="index.html" css:if-content="body.template-featured_videos_homepage" />
    
    <theme href="video.html" css:if-content="body.template-video_view" />

    <theme href="text.html" />
    
    <!-- ALL PAGES -->
    <rules>

        <!-- Drop the viewport meta tag from Plone -->
        <drop css:content="meta[name=viewport]"/>
        
        <!-- Copy all meta tags -->
        <before content="/html/head/meta" css:theme="#css" />
        
        <!-- Get page title -->
        <replace content="/html/head/title" theme="/html/head/title"/>

        <!-- Copy the <base> tag -->
        <copy content="/html/head/base" theme="/html/head/base" />

        <!-- copy body attrs -->
        <prepend theme="/html/body" content="/html/body/@class" />
        <prepend theme="/html/body" content="/html/body/@id" />
        <prepend theme="/html/body" content="/html/body/@dir" />

        <!-- Copy style and link tags in the order they appear in the content -->
        <after content="/html/head/style | /html/head/link" css:theme="#css" />

        <!-- Drop the "type" attribute from <script> tags. HTML5 doesn't mandate
             it and we can save a few bytes there. -->
        <drop css:content="script" attributes="type"/>

        <!-- Copy script tags in the order they appear in the content but place
             them at the bottom of the theme. -->
        <before
            css:content="head > script"
            css:theme="#javascript_at_bottom"
            />

        <!-- Copy inline javascripts from within the body -->
        <!-- reCaptcha needs to stay within the body because they generate html
             in place where the JS is. -->
        <replace
            content="//body//script[not(contains(@src, 'www.google.com/recaptcha/api/challenge'))]"
            css:theme="#javascript_inline"
            method="raw"
            />

        <!-- Drop the scripts within the body because we have copied them to the
             end of the page -->
        <drop content="//div[@id='visual-portal-wrapper']//script[not(contains(@src, 'www.google.com/recaptcha/api/challenge'))]"/>

        <!-- Drop the javascript target from the theme -->
        <drop css:theme="#javascript_at_bottom"/>

        <!-- Copy over the id/class attributes on the body tag.
             This is important for per-section styling -->
        <merge attributes="class" css:content="body" css:theme="body" />
        <copy attributes="id dir" css:content="body" css:theme="body" />

        <!--portlet managers -->
        <prepend css:content="#portletmanager-plone-leftcolumn" css:theme="#mid-container" />
        <append css:content="#portletmanager-plone-rightcolumn" css:theme="#mid-container" />


        <!-- HEADER -->
        
        <!-- Copy search box -->
        <copy css:content="#portal-searchbox" css:theme="div.search" />
        
        <!-- copy user menu -->
        <rules css:if-content="a#user-name">
            <copy css:content-children="dl#portal-personaltools dd.actionMenuContent > ul" css:theme="#user-menu ul.dropdown" />
            <copy css:content-children="a#user-name" css:theme="ul#user-menu > li.header-button > a.user" />
        </rules>
        <rules css:if-content="ul#portal-personaltools > li#anon-personalbar">
            <copy css:content="a#personaltools-login" css:theme="ul#user-menu" />
            <drop css:theme="#user-menu ul.dropdown" />
        </rules>

        <!-- copy browse menu -->
        <copy css:content-children="dl.portletBrowse > dt" css:theme="ul#browse-menu > li.header-button > a.user" />
        <copy css:content="dd.browse-portlet" css:theme="ul#browse-menu ul.dropdown" />

        <!-- copy upload menu -->
        <copy css:content-children="dl.portletPublishPortlet > dt" css:theme="ul#publish-menu > li.header-button > a.user" />
        <copy css:content="dd.publish-portlet" css:theme="ul#publish-menu ul.dropdown" />

        <!-- copy language selector -->
        <copy css:content-children="ul#portal-languageselector li.currentLanguage" css:theme="ul#language-menu > li a" />
        <copy css:content-children="ul#portal-languageselector" css:theme="#language-menu ul.dropdown" />

        <!-- logo -->
        <copy attributes="href title" css:content="a#portal-logo" css:theme="a.main-logo-link" />
        <copy attributes="href title" css:content="a#portal-logo" css:theme="a.main-title-link" />


        <!-- FOOTER -->
        <!-- About us -->
        <replace css:theme="ul#navigation-tree">
            <ul id="navigation-tree">
            <xsl:for-each select="//*[@class='portlet portletNavigationTree']/dd/ul/li">
                <li>
                    <xsl:copy-of select="a" />
                </li>
            </xsl:for-each>
            </ul>
        </replace>
        
        <!-- Projects -->
        <!--copy css:content="dl.portletProjects" css:theme="ul#projects-tree" /-->
        <replace css:theme="ul#projects-tree">
            <ul id="projects-tree">
            <xsl:for-each select="//*[@class='portlet portletProjects']/ul/li">
                <li>
                    <xsl:copy-of select="a" />
                </li>
            </xsl:for-each>
            </ul>
        </replace>

        <!-- Newsletter -->
        <copy css:content="#newsletter-portlet" css:theme="#newsletter-footer" />

        <!-- Content footer is for siteelement doormat, so update this rule if
             doormat is needed for the theme -->
        <drop css:theme="#content-footer" />       
        <copy css:content-children=".siteelement-footertext .footertext" css:theme="#colophon" />

        <!-- video listings -->
        <replace css:theme="#mid-container #latestvideos">
            <div id="latestvideos" class="row content">
            <xsl:for-each css:select="dl#featured-video dd.featuredItem">
                <div class="four columns video">
                    <xsl:copy-of css:select="a.featured-video-image"/>
                    <div class="rollover">
                        <p><a><xsl:copy-of select="a[@class='featured-video-image']/@href" /><xsl:copy-of select="substring(p/text(),0, 130)" />...</a></p>
                        <span class="country"><xsl:copy-of select="dl[@class='plumi-country plumi-props-listing']/dt/text()" />: <xsl:copy-of select="dl[@class='plumi-country plumi-props-listing']//a" /></span>
                    </div>
                    <div class="proxy-under"></div>
                    <div class="wrapper-under">
                        <div class="under">
                            <span class="duration"><xsl:copy-of css:select=".featured-video-duration span" /></span>
                            <h5><xsl:copy-of css:select="h4 a.featuredItemTitle"/></h5>
                        </div>
                    </div>
                </div>
            </xsl:for-each>
            </div>
        </replace>
        <drop css:content="#featured-video" />
        <!-- video listings -->

    </rules>


    <!-- HOMEPAGE -->
    <rules css:if-content="body.template-featured_videos_homepage">
        <replace theme="//*[@id='featuredvideo']/div[1]" css:content="dl#featured-video video"/>

        <!-- In order for this to work, we need News, Comments, Blogs portlets with more link and dates enabled.
             The portlets take their class names according to their names, so keep the portlets News, Comments, Blogs
             For the featured items, we need portlets Feature 1 and Featured 2, showing 1 item, and the hack on the portlets collection
             to display the image when it sees 1 item -->

        <!-- News -->
        <copy css:content="dl.portlet-collection-news dt.portletHeader a" css:theme="h4#news-title" />
        <replace css:theme="ul#news-right-portlet">
        <ul id="news-right-portlet">
           <xsl:for-each css:select="dl.portlet-collection-news dd.portletItem">
               <li>
                    <p class="date"><xsl:copy-of css:select="a span.portletItemDetails" /></p>
                    <h5><a><xsl:copy-of select="a/@*" /><xsl:copy-of select="a/text()" /></a></h5>
               </li>
           </xsl:for-each>
        </ul>
        </replace>
         <replace css:theme="#more-news" css:content="dl.portlet-collection-news dd.portletFooter" />
       
        <!-- Comments -->
        <copy css:content="dl.portlet-collection-comments dt.portletHeader a" css:theme="h4#comments-title" />
        <replace css:theme="ul#comments-right-portlet">
        <ul id="comments-right-portlet">
           <xsl:for-each css:select="dl.portlet-collection-comments dd.portletItem">
               <li>
                    <p class="date"><xsl:copy-of css:select="a span.portletItemDetails" /></p>
                    <h5><a><xsl:copy-of select="a/@*" /><xsl:copy-of select="a/text()" /></a></h5>
               </li>
           </xsl:for-each>
        </ul>
        </replace>
         <replace css:theme="#more-comments" css:content="dl.portlet-collection-comments dd.portletFooter" />


       <!-- Blogs -->
        <copy css:content="dl.portlet-collection-blog dt.portletHeader a" css:theme="h4#blog-title" />
        <replace css:theme="ul#blog-right-portlet">
        <ul id="blog-right-portlet">
           <xsl:for-each css:select="dl.portlet-collection-blog dd.portletItem">
               <li>
                    <p class="date"><xsl:copy-of css:select="a span.portletItemDetails" /></p>
                    <h5><a><xsl:copy-of select="a/@*" /><xsl:copy-of select="a/text()" /></a></h5>
               </li>
           </xsl:for-each>
        </ul>
        </replace>


        <!-- Featured items. Right portlets 1 -->
        <copy css:content="div.featured-filmmaker" css:theme="div.featured-filmmaker" />
        <copy css:content="div#featured-left" css:theme="div#featured-left" />
        <copy css:content="div#featured-right" css:theme="div#featured-right" />

        <!-- Social Networks-->
        <copy css:content-children="div.social-networks" css:theme="div.social-networks" />
        <!-- Latest videos -->
        <replace css:theme="#mid-container #latestvideos">
            <div id="latestvideos" class="row content">
            <xsl:for-each css:select="#featured-latest-videos dd.featuredItem">
                <div class="four columns video">
                    <xsl:copy-of css:select="a.featured-video-image"/>
                    <div class="rollover">
                        <p><a><xsl:copy-of select="a[@class='featured-video-image']/@href" /><xsl:copy-of select="substring(p/text(),0, 130)" />...</a></p>
                        <span class="country"><xsl:copy-of select="dl[@class='plumi-country plumi-props-listing']/dt/text()" />: <xsl:copy-of select="dl[@class='plumi-country plumi-props-listing']//a" /></span>
                    </div>
                    <div class="proxy-under"></div>
                    <div class="wrapper-under">
                        <div class="under">
                            <span class="duration"><xsl:copy-of css:select=".featured-video-duration span" /></span>
                            <h5><xsl:copy-of css:select="h4 a.featuredItemTitle"/></h5>
                        </div>
                    </div>
                </div>
            </xsl:for-each>
            </div>
        </replace>        
    </rules>
    
    <!-- VIDEO VIEW PAGE -->
    <rules css:if-content="body.template-video_view">
        
        <prepend css:theme="div.video-content">
            <div class="row no-v-padding">
                <xsl:copy-of css:select="#edit-bar" />
                <xsl:copy-of css:select="dl.portalMessage" />
            </div>
        </prepend>
        <copy css:content="#content h1.documentFirstHeading > span" css:theme="#video-title h1" /> 
        <copy css:theme=".video" css:content="#video-core" /> 
        <copy css:theme="#description" css:content="#content p.documentDescription" /> 
        <copy css:theme="#full-description" css:content="#full-description > div" /> 
        <copy css:theme="#video-info" css:content="#video-infos" /> 
        <append css:theme="#video-info" css:content="#video-licensing" /> 
        <append css:theme="#video-info" css:content="#video-transcoding" /> 
        <copy css:theme="#video-comments" css:content=".discussion" /> 
        <append css:theme="#video-comments" css:content="#commenting" /> 
    
        <replace css:theme=".video-list">
            <ul class="video-list">
            <xsl:for-each css:select="#authors_latest li">
                <li class="video-item">
                    <xsl:copy-of css:select="a" />
                </li>
            </xsl:for-each>
            </ul>
        </replace>
    </rules>
    
    <rules css:if-content="#visual-portal-wrapper">
        <copy css:content="#portal-column-content" css:theme="#post-content > div.text-content" />
        <drop css:content="#portal-breadcrumbs" />
        <drop css:content="span.documentModified > span" />
    </rules> 
    
</rules>
